<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Retirada de EPIs</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilos permanecem os mesmos */
  </style>
</head>
<body>
  <h1>Retirada de EPIs</h1>

  <form id="formRetirada">
    <input type="text" name="ldap" placeholder="Matricula do funcionário" required />
    <input type="text" name="nome_colaborador" placeholder="Nome do funcionário" required />
    <input type="text" name="nome_epi" placeholder="Nome do EPI" required />
    <input type="number" name="quantidade" placeholder="Quantidade a retirar" required />
    <input type="text" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Registrar Retirada</button>
  </form>

  <h1>Histórico de Retirada</h1>
  <div class="centralizado">
    <input type="text" id="buscaLdap" placeholder="Filtrar por Matricula..." />
  </div>

  <table border="1" id="tabelaRetiradas">
    <thead>
      <tr>
        <th>Data</th>
        <th>Matricula</th>
        <th>Colaborador</th>
        <th>Nome do EPI</th>
        <th>Quantidade</th>
        <th>Tamanho</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populado via JS -->
    </tbody>
  </table>

  <div style="text-align:center; margin: 20px;">
    <a href="index.html"><button>Voltar ao Início</button></a>
    <a href="estoque.html"><button>Ir ao Estoque</button></a>
  </div>

<script>
  // Função para buscar as retiradas do banco
  async function carregarRetiradas() {
    const response = await fetch('backend/listar_retiradas.php');
    const dados = await response.json();
    return dados;
  }

  // Função para registrar uma retirada
  async function registrarRetirada(retirada) {
    await fetch('backend/registrar_retirada.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(retirada)
    });
  }

  // Função para renderizar as retiradas na tabela
  async function renderizarRetiradas() {
    const tbody = document.querySelector('#tabelaRetiradas tbody');
    const retiradas = await carregarRetiradas();
    tbody.innerHTML = '';

    retiradas.forEach((r) => {
      const data = new Date(r.data).toLocaleString();
      tbody.innerHTML += `
        <tr>
          <td>${data}</td>
          <td>${r.ldap}</td>
          <td>${r.nome_colaborador}</td>
          <td>${r.nome_epi}</td>
          <td>${r.quantidade}</td>
          <td>${r.tamanho || '-'}</td>
          <td>
            <button class="btn-azul" onclick="editarRetirada('${r.id}')">Editar</button>
            <button class="btn-vermelho" onclick="deletarRetirada('${r.id}')">Excluir</button>
          </td>
        </tr>
      `;
    });
  }

  // Filtro de busca por matrícula
  document.querySelector('#buscaLdap').addEventListener('input', function () {
    const filtro = this.value.toLowerCase();
    const linhas = document.querySelectorAll('#tabelaRetiradas tbody tr');
    linhas.forEach(linha => {
      const matricula = linha.cells[1].textContent.toLowerCase();
      linha.style.display = matricula.includes(filtro) ? '' : 'none';
    });
  });

  // Evento de carregamento da página
  document.addEventListener('DOMContentLoaded', () => {
    renderizarRetiradas();

    const form = document.querySelector('#formRetirada');
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const nova = {
        id: crypto.randomUUID(),
        data: new Date().toISOString(),
        ldap: form.ldap.value,
        nome_colaborador: form.nome_colaborador.value,
        nome_epi: form.nome_epi.value,
        quantidade: parseInt(form.quantidade.value),
        tamanho: form.tamanho.value
      };

      registrarRetirada(nova);
      form.reset();
      renderizarRetiradas();
    });
  });
</script>

</body>
</html>

