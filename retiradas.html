<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Retirada de EPIs</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Retirada de EPIs</h1>

  <form id="formRetirada">
    <input type="text" name="ldap" placeholder="Matrícula do funcionário" required />
    <input type="text" name="nome_colaborador" placeholder="Nome do funcionário" required />
    <input type="text" name="nome_epi" placeholder="Nome do EPI" required />
    <input type="number" name="quantidade" placeholder="Quantidade a retirar" required />
    <input type="text" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Registrar Retirada</button>
  </form>

  <h1>Histórico de Retirada</h1>

  <div class="centralizado">
    <input type="text" id="buscaLdap" placeholder="Filtrar por Matrícula..." />
  </div>

  <table border="1" id="tabelaRetiradas">
    <thead>
      <tr>
        <th>Data</th>
        <th>Matrícula</th>
        <th>Colaborador</th>
        <th>Nome do EPI</th>
        <th>Quantidade</th>
        <th>Tamanho</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populado via JS -->
    </tbody>
  </table>

  <div style="text-align:center; margin: 20px;">
    <a href="index.html"><button>Voltar ao Início</button></a>
    <a href="estoque.html"><button>Ir ao Estoque</button></a>
  </div>

<script>
  let retiradas = [];
  let estoque = [];

  function carregarLocal() {
    const dadosRetiradas = localStorage.getItem("retiradasEPI");
    const dadosEstoque = localStorage.getItem("estoqueEPI");
    retiradas = dadosRetiradas ? JSON.parse(dadosRetiradas) : [];
    estoque = dadosEstoque ? JSON.parse(dadosEstoque) : [];
  }

  function salvarLocal() {
    localStorage.setItem("retiradasEPI", JSON.stringify(retiradas));
    localStorage.setItem("estoqueEPI", JSON.stringify(estoque));
  }

  function renderizarRetiradas() {
    const tbody = document.querySelector('#tabelaRetiradas tbody');
    tbody.innerHTML = '';

    retiradas.forEach((retirada, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${retirada.nomeFuncionario}</td>
        <td>${retirada.nomeEPI}</td>
        <td>${retirada.quantidade}</td>
        <td>${retirada.data}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.querySelector('#formRetiradaEPI').addEventListener('submit', function (e) {
    e.preventDefault();

    const nomeFuncionario = this.nomeFuncionario.value.trim();
    const nomeEPI = this.nomeEPI.value.trim();
    const quantidade = parseInt(this.quantidade.value);

    // Busca o EPI correspondente no estoque
    const epiEstoque = estoque.find(e => e.nome === nomeEPI);

    if (!epiEstoque) {
      alert("EPI não encontrado no estoque.");
      return;
    }

    if (epiEstoque.quantidade < quantidade) {
      alert("Quantidade insuficiente no estoque.");
      return;
    }

    // Realiza a retirada e atualiza o estoque
    epiEstoque.quantidade -= quantidade;

    const retirada = {
      nomeFuncionario,
      nomeEPI,
      quantidade,
      data: new Date().toLocaleDateString("pt-BR")
    };

    retiradas.push(retirada);
    salvarLocal();
    renderizarRetiradas();
    this.reset();
  });

  window.onload = () => {
    carregarLocal();
    renderizarRetiradas();
  };
</script>


</body>
</html>
