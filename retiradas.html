<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Retirada de EPIs</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Retirada de EPIs</h1>

  <form id="formRetirada">
    <input type="text" name="ldap" placeholder="Matrícula do funcionário" required />
    <input type="text" name="nome_colaborador" placeholder="Nome do funcionário" required />
    <input type="text" name="nome_epi" placeholder="Nome do EPI" required />
    <input type="number" name="quantidade" placeholder="Quantidade a retirar" required />
    <input type="text" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Registrar Retirada</button>
  </form>

  <h1>Histórico de Retirada</h1>

  <div class="centralizado">
    <input type="text" id="buscaLdap" placeholder="Filtrar por Matrícula..." />
  </div>

  <table border="1" id="tabelaRetiradas">
    <thead>
      <tr>
        <th>Data</th>
        <th>Matrícula</th>
        <th>Colaborador</th>
        <th>Nome do EPI</th>
        <th>Quantidade</th>
        <th>Tamanho</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populado via JS -->
    </tbody>
  </table>

  <div style="text-align:center; margin: 20px;">
    <a href="index.html"><button>Voltar ao Início</button></a>
    <a href="estoque.html"><button>Ir ao Estoque</button></a>
  </div>

<script>
  let retiradas = [];

  function carregarLocal() {
    const dados = localStorage.getItem("historicoRetirada");
    retiradas = dados ? JSON.parse(dados) : [];
  }

  function salvarLocal() {
    localStorage.setItem("historicoRetirada", JSON.stringify(retiradas));
  }

  function renderizarRetiradas() {
    const tbody = document.querySelector('#tabelaRetiradas tbody');
    tbody.innerHTML = '';

    retiradas.forEach((r, index) => {
      const data = new Date(r.data).toLocaleString();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data}</td>
        <td>${r.ldap}</td>
        <td>${r.nome_colaborador}</td>
        <td>${r.nome_epi}</td>
        <td>${r.quantidade}</td>
        <td>${r.tamanho || '-'}</td>
        <td>
          <button onclick="editarRetirada(${index})">Editar</button>
          <button onclick="removerRetirada(${index})">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function adicionarRetirada(retirada) {
    retiradas.push(retirada);
    salvarLocal();
    renderizarRetiradas();
  }

  document.querySelector('#formRetirada').addEventListener('submit', function (e) {
    e.preventDefault();

    const retirada = {
      id: crypto.randomUUID(),
      data: new Date().toISOString(),
      ldap: this.ldap.value.trim(),
      nome_colaborador: this.nome_colaborador.value.trim(),
      nome_epi: this.nome_epi.value.trim(),
      quantidade: parseInt(this.quantidade.value),
      tamanho: this.tamanho.value.trim() || '-'
    };

    adicionarRetirada(retirada);
    this.reset();
  });

  document.querySelector('#buscaLdap').addEventListener('input', function () {
    const filtro = this.value.toLowerCase();
    const linhas = document.querySelectorAll('#tabelaRetiradas tbody tr');
    linhas.forEach(linha => {
      const matricula = linha.cells[1].textContent.toLowerCase();
      linha.style.display = matricula.includes(filtro) ? '' : 'none';
    });
  });

  function removerRetirada(index) {
    retiradas.splice(index, 1);
    salvarLocal();
    renderizarRetiradas();
  }

  function editarRetirada(index) {
    const r = retiradas[index];
    const novoNome = prompt("Novo nome do colaborador:", r.nome_colaborador);
    if (novoNome === null) return;

    const novoEpi = prompt("Novo nome do EPI:", r.nome_epi);
    if (novoEpi === null) return;

    const novaQuantidade = prompt("Nova quantidade:", r.quantidade);
    if (novaQuantidade === null) return;

    const novoTamanho = prompt("Novo tamanho:", r.tamanho);
    if (novoTamanho === null) return;

    r.nome_colaborador = novoNome;
    r.nome_epi = novoEpi;
    r.quantidade = parseInt(novaQuantidade);
    r.tamanho = novoTamanho;

    salvarLocal();
    renderizarRetiradas();
  }

  window.onload = () => {
    carregarLocal();
    renderizarRetiradas();
  };
</script>

</body>
</html>
