<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Editar EPI</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Editar EPI</h1>

  <form id="formEditarEPI" style="display:none;">
    <input type="text" id="nome" name="nome" placeholder="Nome do EPI" required />
    <input type="number" id="quantidade" name="quantidade" placeholder="Quantidade" required min="0" />
    <input type="text" id="categoria" name="categoria" placeholder="Categoria do EPI" required />
    <input type="text" id="tamanho" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Salvar Alterações</button>
  </form>

  <div style="margin-top: 20px; text-align: center;">
    <a href="index.html"><button type="button">Cancelar</button></a>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDrLZd3S8UsVuqMqaE5WpZGlKuWb7E7pRU",
    authDomain: "leroycontroll.firebaseapp.com",
    databaseURL: "https://leroycontroll-default-rtdb.firebaseio.com",
    projectId: "leroycontroll",
    storageBucket: "leroycontroll.appspot.com",
    messagingSenderId: "6215288603",
    appId: "1:6215288603:web:b8c8882a4a22a396a5f5be"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let usuarioAtual = null;
  let epiId = null; // pega da URL, por exemplo

  onAuthStateChanged(auth, user => {
    if (user) {
      usuarioAtual = user;
      carregarEPI();
    } else {
      alert("Você precisa estar logado para editar.");
      // redirecionar se quiser
    }
  });

  // Função para carregar dados do EPI para o formulário (simplificado)
  async function carregarEPI() {
    const urlParams = new URLSearchParams(window.location.search);
    epiId = urlParams.get('id');
    if (!epiId) {
      alert("EPI não especificado.");
      return;
    }

    const epiRef = ref(db, 'epis/' + epiId);
    const snapshot = await get(epiRef);
    const epi = snapshot.val();

    if (!epi) {
      alert("EPI não encontrado.");
      return;
    }

    // Preenche o formulário (supondo ids iguais aos campos)
    document.getElementById('nome').value = epi.nome;
    document.getElementById('quantidade').value = epi.quantidade;
    document.getElementById('categoria').value = epi.categoria;
    document.getElementById('tamanho').value = epi.tamanho || '';
  }

  // Função para atualizar o EPI no banco
  async function atualizarEPI(id, dados) {
    const epiRef = ref(db, 'epis/' + id);
    await set(epiRef, dados);
  }

  // Função para enviar relatório para o Firebase
  async function enviarRelatorio(dadosRelatorio) {
    const relatoriosRef = ref(db, 'relatorios');
    await push(relatoriosRef, dadosRelatorio);
  }

  const form = document.getElementById('formEditarEPI');

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const nome = document.getElementById('nome').value.trim();
    const quantidade = Number(document.getElementById('quantidade').value);
    const categoria = document.getElementById('categoria').value.trim();
    const tamanho = document.getElementById('tamanho').value.trim();

    if (!nome || !categoria || isNaN(quantidade) || quantidade < 0) {
      alert('Preencha todos os campos corretamente.');
      return;
    }

    try {
      // Pega o EPI antigo pra comparar quantidade
      const epiRef = ref(db, 'epis/' + epiId);
      const snapshot = await get(epiRef);
      const epiAntigo = snapshot.val() || {};
      const quantidadeAntiga = Number(epiAntigo.quantidade) || 0;
      const alteracao = quantidade - quantidadeAntiga;

      // Atualiza o EPI
      await atualizarEPI(epiId, { nome, quantidade, categoria, tamanho });

      // Envia relatório
      await enviarRelatorio({
        usuario: usuarioAtual.email || usuarioAtual.uid || 'Usuário desconhecido',
        tipoAcao: 'Edição',
        nomeEPI: nome,
        categoria: categoria,
        tamanho: tamanho || '-',
        alteracao: alteracao,
        dataHora: new Date().toISOString()
      });

      alert('EPI atualizado com sucesso!');
      window.location.href = 'index.html'; // ou onde quiser

    } catch (erro) {
      alert('Erro ao atualizar EPI: ' + erro.message);
    }
  });
</script>
</body>
</html>
