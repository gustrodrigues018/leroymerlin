<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Editar EPI</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 480px; margin: 40px auto; }
    input, button { width: 100%; margin: 8px 0; padding: 10px; font-size: 16px; }
    button { cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; }
    button.cancelar { background-color: #e74c3c; }
  </style>
</head>
<body>
  <h1>Editar EPI</h1>

  <form id="formEditarEPI" style="display:none;">
    <input type="text" id="nome" name="nome" placeholder="Nome do EPI" required />
    <input type="number" id="quantidade" name="quantidade" placeholder="Quantidade" required min="0" step="1"/>
    <input type="text" id="categoria" name="categoria" placeholder="Categoria do EPI" required />
    <input type="text" id="tamanho" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Salvar Alterações</button>
  </form>

  <button class="cancelar" id="btnCancelar">Cancelar e Voltar</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDrLZd3S8UsVuqMqaE5WpZGlKuWb7E7pRU",
      authDomain: "leroycontroll.firebaseapp.com",
      databaseURL: "https://leroycontroll-default-rtdb.firebaseio.com",
      projectId: "leroycontroll",
      storageBucket: "leroycontroll.appspot.com",
      messagingSenderId: "6215288603",
      appId: "1:6215288603:web:b8c8882a4a22a396a5f5be"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const form = document.getElementById('formEditarEPI');
    const btnCancelar = document.getElementById('btnCancelar');

    const urlParams = new URLSearchParams(window.location.search);
    const idEpiOriginal = urlParams.get('id');

    if (!idEpiOriginal) {
      alert('ID do EPI não informado!');
      window.location.href = 'index.html';
    }

    function gerarIdEPI(epi) {
      // Remove espaços e caracteres estranhos pra evitar bugs no ID
      const clean = str => str.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
      return `${clean(epi.nome)}-${clean(epi.categoria)}-${clean(epi.tamanho || '-')}`;
    }

    async function carregarEpi(id) {
      const epiRef = ref(db, 'estoque/' + id);
      const snapshot = await get(epiRef);
      const epi = snapshot.val();

      if (!epi) {
        alert('EPI não encontrado.');
        window.location.href = 'index.html';
        return;
      }

      form.nome.value = epi.nome || '';
      form.quantidade.value = epi.quantidade ?? 0;
      form.categoria.value = epi.categoria || '';
      form.tamanho.value = (epi.tamanho && epi.tamanho !== '-') ? epi.tamanho : '';
      form.style.display = 'block';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const nome = form.nome.value.trim();
        const categoria = form.categoria.value.trim();
        const tamanho = form.tamanho.value.trim() || '-';
        let quantidade = form.quantidade.value;

        if (!nome || !categoria || quantidade === '' || isNaN(quantidade) || Number(quantidade) < 0) {
          alert('Preencha todos os campos corretamente.');
          return;
        }

        quantidade = Number(quantidade);

        const novoEpi = { nome, quantidade, categoria, tamanho, data: new Date().toISOString() };
        const novoId = gerarIdEPI(novoEpi);

        if (novoId !== idEpiOriginal) {
          await remove(ref(db, 'estoque/' + idEpiOriginal));
        }

        await set(ref(db, 'estoque/' + novoId), novoEpi);

        alert('EPI atualizado com sucesso!');
        window.location.href = 'index.html';

      } catch (error) {
        alert('Erro ao salvar EPI: ' + error.message);
        console.error(error);
      }
    });

    btnCancelar.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    carregarEpi(idEpiOriginal);

  </script>
</body>
</html>
