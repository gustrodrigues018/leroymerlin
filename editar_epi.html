<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Editar EPI</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Editar EPI</h1>

  <form id="formEditarEPI" style="display:none;">
    <input type="text" id="nome" name="nome" placeholder="Nome do EPI" required />
    <input type="number" id="quantidade" name="quantidade" placeholder="Quantidade" required min="0" />
    <input type="text" id="categoria" name="categoria" placeholder="Categoria do EPI" required />
    <input type="text" id="tamanho" name="tamanho" placeholder="Tamanho (opcional)" />
    <button type="submit">Salvar Alterações</button>
  </form>

  <div style="margin-top: 20px; text-align: center;">
    <a href="index.html"><button type="button">Cancelar</button></a>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDrLZd3S8UsVuqMqaE5WpZGlKuWb7E7pRU",
    authDomain: "leroycontroll.firebaseapp.com",
    databaseURL: "https://leroycontroll-default-rtdb.firebaseio.com",
    projectId: "leroycontroll",
    storageBucket: "leroycontroll.appspot.com",
    messagingSenderId: "6215288603",
    appId: "1:6215288603:web:b8c8882a4a22a396a5f5be"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const form = document.getElementById('formEditarEPI');
  const inputNome = document.getElementById('nome');
  const inputQuantidade = document.getElementById('quantidade');
  const inputCategoria = document.getElementById('categoria');
  const inputTamanho = document.getElementById('tamanho');

  let usuarioAtual = null;
  let epiId = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      usuarioAtual = user;
      carregarEPI();
    } else {
      alert("Você precisa estar logado para editar.");
      // opcional: redirecionar para login
    }
  });

  async function carregarEPI() {
    const urlParams = new URLSearchParams(window.location.search);
    epiId = urlParams.get('id');

    if (!epiId) {
      alert("EPI não especificado.");
      return;
    }

    const epiRef = ref(db, 'epis/' + epiId);
    const snapshot = await get(epiRef);
    const epi = snapshot.val();

    if (!epi) {
      alert("EPI não encontrado.");
      return;
    }

    inputNome.value = epi.nome || '';
    inputQuantidade.value = epi.quantidade || 0;
    inputCategoria.value = epi.categoria || '';
    inputTamanho.value = epi.tamanho || '';

    form.style.display = 'block';  // mostra o form só depois que carrega os dados
  }

  async function atualizarEPI(id, dados) {
    const epiRef = ref(db, 'epis/' + id);
    await set(epiRef, dados);
  }

  async function enviarRelatorio(dadosRelatorio) {
    const relatoriosRef = ref(db, 'relatorios');
    await push(relatoriosRef, dadosRelatorio);
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const nome = inputNome.value.trim();
    const quantidade = Number(inputQuantidade.value);
    const categoria = inputCategoria.value.trim();
    const tamanho = inputTamanho.value.trim();

    if (!nome || !categoria || isNaN(quantidade) || quantidade < 0) {
      alert('Preencha todos os campos obrigatórios corretamente.');
      return;
    }

    try {
      const epiRef = ref(db, 'epis/' + epiId);
      const snapshot = await get(epiRef);
      const epiAntigo = snapshot.val() || {};
      const quantidadeAntiga = Number(epiAntigo.quantidade) || 0;
      const alteracao = quantidade - quantidadeAntiga;

      await atualizarEPI(epiId, { nome, quantidade, categoria, tamanho });

      await enviarRelatorio({
        usuario: usuarioAtual.email || usuarioAtual.uid || 'Usuário desconhecido',
        tipoAcao: 'Edição',
        nomeEPI: nome,
        categoria,
        tamanho: tamanho || '-',
        alteracao,
        dataHora: new Date().toISOString()
      });

      alert('EPI atualizado com sucesso!');
      // opcional: redirecionar para a lista ou outra página
      // window.location.href = 'index.html';

    } catch (erro) {
      alert('Erro ao atualizar EPI: ' + erro.message);
    }
  });
</script>

</body>
</html>
